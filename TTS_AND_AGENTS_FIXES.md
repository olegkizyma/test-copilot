# ATLAS TTS і Логіка Агентів - Виправлення

## Виправлені Проблеми

### 1. Українська TTS Система
- **Проблема**: MPS помилка в ukrainian-tts, fallback на web TTS
- **Виправлення**: 
  - Змінено порт з 3001 на 3000 в `intelligent_voice_manager.py`
  - Додано `flask-cors` до залежностей
  - Mock TTS сервер тепер працює на http://localhost:3000

### 2. TTS Синхронізація з Чатом
- **Проблема**: TTS не синхронізована з чатом, озвучує фрагменти замість повних повідомлень
- **Виправлення**:
  - Система накопичення повідомлень агентів (`agentMessages: Map`)
  - TTS черга для запобігання паралельного відтворення
  - Функція `finalizeAgentMessage()` для озвучування повних повідомлень
  - Покращено відстеження завершення відтворення

### 3. Логіка Агентів Atlas → Тетяна → Гриша
- **Проблема**: Не дотримувався правильний цикл "Criterion → Evidence"
- **Виправлення**:
  - Додано `evidence_validator_system` для Гріші
  - Покращено `execution_approach` для Тетяни з вимогою збору доказів
  - Додано `evidence_requirements` в Atlas output format
  - Створено `criterion_evidence_enforcer` правило

## Поточний Стан Системи

### Запуск
```bash
# У frontend_new/
source venv/bin/activate
python ukrainian_tts_server.py &  # Порт 3000
python app/atlas_server.py &      # Порт 5001

# У frontend_new/orchestrator/
node server.js &                  # Порт 5101
```

### Тестування TTS
```bash
curl -X POST -H "Content-Type: application/json" \
  -d '{"text":"Привіт від Atlas", "agent":"atlas"}' \
  http://127.0.0.1:5001/api/voice/synthesize \
  --output test.wav
```

### Доступні Голоси
- `atlas` (dmytro) - низький чоловічий голос
- `tetyana` (oleksa) - середній жіночий голос  
- `grisha` (robot) - низький роботизований голос

## Покращена Логіка Роботи

### Atlas (Планувальник)
- Аналізує завдання і створює `evidence_requirements`
- Визначає конкретні докази які потрібні для верифікації

### Тетяна (Виконавець) 
- Виконує завдання покроково
- **ОБОВ'ЯЗКОВО** збирає докази: скріншоти, логи, URL, файли
- Звітує в форматі "Criterion → Evidence"

### Гриша (Верифікатор)
- Перевіряє наявність доказів для кожного критерію
- Застосовує `evidence_validator_system`
- Відхиляє завдання без конкретних доказів

## Правило Criterion → Evidence

**Кожне завдання повинно мати:**
1. **Criterion**: Чіткий критерій (що саме треба зробити)
2. **Evidence**: Конкретний доказ виконання:
   - Скріншоти екранів
   - Логи команд з виводом  
   - URL відкритих сторінок
   - Створені файли
   - Статус повідомлення

**Без доказів завдання вважається невиконаним.**

## Приклад Правильної Роботи

### Atlas:
```
Завдання: Знайти відео трейлерів 2025
Evidence Requirements:
- Скріншот результатів пошуку
- URL відкритого відео  
- Скріншот повноекранного режиму
- Підтвердження максимального звуку
```

### Тетяна:
```
✅ Criterion: Знайти відео трейлерів 2025
✅ Evidence: Відкрито https://youtube.com/watch?v=xxx, скріншот збережено

✅ Criterion: Повноекранний режим
✅ Evidence: Скріншот відео в повноекранному режимі збережено

✅ Criterion: Максимальний звук
✅ Evidence: Системний звук встановлено на 100%, скріншот налаштувань
```

### Гриша:
```
Перевірка:
- Criterion 1 ✅ Evidence надано
- Criterion 2 ✅ Evidence надано  
- Criterion 3 ✅ Evidence надано

Вердикт: Завдання виконано повністю
```

## Технічні Деталі

### TTS Синхронізація
```javascript
// Нова логіка накопичення повідомлень
voiceSystem: {
  agentMessages: new Map(), // Накопичення тексту
  ttsQueue: [],             // Черга TTS
  isProcessingTTS: false,   // Запобігання паралелізму
  lastAgentComplete: null   // Відстеження завершення
}
```

### Improved Voice Workflow
1. Агент почив відправляти повідомлення → накопичуємо в `agentMessages`
2. Агент закінчив повідомлення → викликаємо `finalizeAgentMessage()`
3. Чекаємо завершення попереднього TTS → синтезуємо повний текст
4. Відтворюємо TTS → оновлюємо `lastAgentComplete`

Це забезпечує правильну синхронізацію і запобігає перекриттю голосів.